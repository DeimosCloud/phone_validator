---

- name: Check if PostgreSQL user exists
  become_user: postgres
  shell: "psql -tAc \"SELECT 1 FROM pg_roles WHERE rolname='{{ postgres_user }}'\""
  register: user_exists

- name: Check if PostgreSQL database exists
  become_user: postgres
  shell: "psql -lqt | cut -d \\| -f 1 | grep -qw {{ postgres_db }}"
  register: db_exists
  ignore_errors: yes

- name: Create PostgreSQL user
  become_user: postgres
  command: "createuser {{ postgres_user }}"
  when: not user_exists.stdout

- name: Create PostgreSQL database
  become_user: postgres
  command: "createdb {{ postgres_db }}"
  when: not db_exists.stdout

- name: Grant privileges to user on database
  become_user: postgres
  command: "psql -c \"GRANT {{ postgres_privileges }} ON DATABASE {{ postgres_db }} TO {{ postgres_user }};\""
